<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>TempestTracker</title>
    <script src="src/model/Tempest.js"></script>

    <link rel="stylesheet" type="text/css" href="semantic.min.css">


    <style>
        body {
            background: url(http://webcdn.pathofexile.com/image/layout/background-awakening-release.jpg?1435660190);
        }
        h1 {
            color: firebrick;
            margin-left: 40px;
        }
        .grayscale{
          filter:grayscale(100%);
        }


    </style>
</head>
<body>
<h1>TempestTracker</h1>

<table class ="sortable" id="Tempest" cellspacing="50" cellpadding="10" style="background-color:ghostwhite">
    <thead><tr><th>Type</th><th>Difficulty</th><th>Zone</th><th>Remaining Time</th></tr></thead>
    <tbody></tbody>
</table>

<menu>
    <li><a href="listTempests.html"><button type="button">List all active tempests</button></a></li>
    <li><a href="createTempest.html"><button type="button">Add a new tempest</button></a></li>
    <li><button type="button" onclick="Tempest.createTestData()">Create test data</button></li>
</menu>

<ul id="esDisplay"></ul>


<div id="content" style="background-color:ghostwhite;" class="ui raised very padded text container segment"></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<script type="text/jsx">

var TempestRating = React.createClass({
  getInitialState: function() {
    return {rating: 0, items: []};
  },
  render: function() {
  }

});

var Tempest = React.createClass({
  render: function() {

    var dif = this.props.expire - Date.now();
    var remain = new Date(dif);
    var mins = remain.getMinutes();
    var str;

    if (mins){
      str = mins + " minutes remaining ";
    }else{
      str = " < 1 minute remaining"
    }


    return (

      <div className="tempest item">
        <div className="ui tiny image">
          <img src="map.png"/>
        </div>
        <div className="content">
          <a className="header">
            {this.props.zone}
          </a>
          <div className="meta">
            <span>{str}</span>
          </div>
          <div className="description">
          <p>

            etc etc sdfsd fksdhfuw qpfj asdknf sdfiqweo fmskldnf sduofhwf sd
            fsd fiusdf nqweipq dfnksdfp owiop jf ksgi gdngkdf goppw fsdf
          </p>

          </div>
          <div className="bottom aligned extra">
          <div className="ui label">{this.props.difficulty}</div>
          <div className="ui label">{this.props.type}</div>

            <div className="ui right floated">
              <img src="jewel.png"/>
              <img src="jewel.png"/>
              <img src="jewel.png"/>
              <img src="jewel.png" className="grayscale"/>
              <img src="jewel.png" className="grayscale"/>
            </div>
          </div>

        </div>
      </div>
    );
  }
});

var TempestList = React.createClass({
  render: function() {

    var tempestNodes = this.props.data.map(function (tempest) {
     return (
       <Tempest type={tempest.type} difficulty={tempest.difficulty} zone={tempest.zone} expire={tempest.expire}>

       </Tempest>
     );
   });

    return (
      <div className="tempestList ui divided items">
        {tempestNodes}
      </div>
    );
  }
});


var CommentBox = React.createClass({
  getInitialState: function() {
    return {data: []};
  },
  loadCommentsFromServer: function() {

    var self = this;
    var es = new EventSource("es");
    es.onerror=function(e){
      es.close();
    }

    es.addEventListener("TEMPEST",function(e){
      var t = JSON.parse(e.data);

      var toAdd=[].concat(t).map(function(x){
        var clone = JSON.parse(JSON.stringify(x));
        clone.expire = new Date(clone.expire);
        return clone;
      });



      var combined = self.state.data.concat(toAdd);
      console.log("toadd",combined);


      self.setState({data:combined});
    });

    //var next = {author: "John McClane", text: "find lucy kill everybody else"};
  //  this.setState({data: this.state.data.concat([next])});
  },
  refreshTempests:function(){

    var now = Date.now();
    var temp = this.state.data.filter(function(t){
      return t.expire > now;
    });

    this.setState({data:temp});

  },
  render: function() {
    return (
      <div className="commentBox">
        <h1>Active Tempests</h1>

        <TempestList data={this.state.data} />

      </div>
    );
  },
  componentDidMount: function() {
    this.loadCommentsFromServer();
    setInterval(this.refreshTempests, 5000);
  },
  pushComment:function(){

  }
});

var data = [
  {author: "Pete Hunt", text: "This is one comment"},
  {author: "Jordan Walke", text: "This is *another* comment"},
  {author: "John McClane", text: "find lucy kill everybody else"}
];



React.render(
  <CommentBox data={data} pollInterval={2000} />,
  document.getElementById('content')
);
</script>


<script>
"use strict";

/*
(function(){

  //var el = document.getElementById("esDisplay");
  var el = document.querySelector("table#Tempest>tbody");

  var temp = [];
  var es = new EventSource("http://gdf3.com:555/es");
  es.onerror=function(e){
    es.close();
  }

  es.addEventListener("TEMPEST",function(e){
    var t = JSON.parse(e.data);

    var toAdd=[].concat(t).map(function(x){
      var clone = JSON.parse(JSON.stringify(x));
      clone.expire = new Date(clone.expire);
      return clone;
    });


    temp = temp.concat(toAdd);
    console.log(temp);
  });

  var refreshList = function(){
    var now = Date.now();

    temp = temp.filter(function(t){
      return t.expire > now;
    });

    var d = document.createDocumentFragment();
    var elements = temp.map(function(t){
      var tr = document.createElement("tr");
      var left = new Date(t.expire - now);

      var mins = left.getMinutes();

      var td = document.createElement("td");
      td.innerHTML=t.type;
      tr.appendChild(td);

      td = document.createElement("td");
      td.innerHTML=t.difficulty;
      tr.appendChild(td);

      td = document.createElement("td");
      td.innerHTML=t.zone;
      tr.appendChild(td);

//      var inner = t.type + " " + t.zone + " " + t.difficulty + ", ";

      td = document.createElement("td");

      if (mins){
        td.innerHTML = mins + " minutes remaining ";
      }else{
        td.innerHTML = " < 1 minute remaining"
      }

      tr.appendChild(td);


  //    n.innerHTML= inner;
    //  return n;
    return tr;
    });

    elements.forEach(function(row){
      d.appendChild(row);
    });

    el.innerHTML="";
    el.appendChild(d);
  };

  setInterval(refreshList,1000);

})();


var HttpClient = function(){
"use strict";
	var Post = function(tempest){
		var promise = new Promise( function (resolve, reject) {

			var client = new XMLHttpRequest();

			client.onload=function(e){
				if (this.status==200){
					resolve(this.status);
				}else{
					reject(this.statusText);
				}

			};

			var json = JSON.stringify(tempest);
			client.open("POST","http://gdf3.com:555/tempest");
			client.send(json);

		});//<-- forgot this )

	};

	return {Post:Post};

};

var testtempest = {"type":"tempest","difficulty":"merciless","zone":"mountain ledge","startTime":"now","endTime":"later"};
var client = HttpClient();

*/
</script>
</body>
</html>
