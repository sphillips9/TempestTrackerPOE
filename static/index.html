<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TempestTracker</title>
<script src="src/model/Tempest.js"></script>

<link rel="stylesheet" type="text/css" href="semantic.min.css">
<script src="semantic.min.js"></script>
<link rel="stylesheet" type="text/css" href="dropdown.css">

    <style>
        body {
            background: url(http://webcdn.pathofexile.com/image/layout/background-awakening-release.jpg?1435660190);
            background-size:cover;
            background-attachment: fixed;
            width:100%;
        }
        h1 {
            color: firebrick;
            margin-left: 40px;
        }
        .grayscale{
          filter:grayscale(100%);
        }
        .ui.raised.segment, .ui.raised.segments {
          box-shadow: 4px 5px 8px 0px rgba(0, 0, 0, 0.62), 0px 2px 10px 0px rgba(34, 36, 38, 0.08);
        }

    </style>
</head>
<body>
<h1>TempestTracker</h1>

<table class ="sortable" id="Tempest" cellspacing="50" cellpadding="10" style="background-color:ghostwhite">
    <thead><tr><th>Type</th><th>Difficulty</th><th>Zone</th><th>Remaining Time</th></tr></thead>
    <tbody></tbody>
</table>

<menu>
    <li><a href="createTempest.html"><button type="button">Add a new tempest</button></a></li>
    <li><button type="button" onclick="Tempest.createTestData()">Create test data</button></li>
</menu>

<ul id="esDisplay"></ul>


<div id="content" style="background-color:ghostwhite;" class="ui raised very padded text container segment"></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<script type="text/jsx">

(function () {
	'use strict';

	function classNames () {

		var classes = '';

		for (var i = 0; i < arguments.length; i++) {
			var arg = arguments[i];
			if (!arg) continue;

			var argType = typeof arg;

			if ('string' === argType || 'number' === argType) {
				classes += ' ' + arg;

			} else if (Array.isArray(arg)) {
				classes += ' ' + classNames.apply(null, arg);

			} else if ('object' === argType) {
				for (var key in arg) {
					if (arg.hasOwnProperty(key) && arg[key]) {
						classes += ' ' + key;
					}
				}
			}
		}

		return classes.substr(1);
	}

	if (typeof module !== 'undefined' && module.exports) {
		module.exports = classNames;
	} else if (typeof define === 'function' && typeof define.amd === 'object' && define.amd){
		// AMD. Register as an anonymous module.
		define(function () {
			return classNames;
		});
	} else {
		window.classNames = classNames;
	}

}());

var _interopRequire = function (obj) { return obj && obj.__esModule ? obj["default"] : obj; };

var _createClass = (function () { function defineProperties(target, props) { for (var key in props) { var prop = props[key]; prop.configurable = true; if (prop.value) prop.writable = true; } Object.defineProperties(target, props); } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

var _get = function get(object, property, receiver) { var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return get(parent, property, receiver); } } else if ("value" in desc && desc.writable) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } };

var _inherits = function (subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) subClass.__proto__ = superClass; };

var _classCallCheck = function (instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } };


var Dropdown = (function (_React$Component) {
  function Dropdown(props) {
    _classCallCheck(this, Dropdown);

    _get(Object.getPrototypeOf(Dropdown.prototype), "constructor", this).call(this, props);
    this.state = {
      selected: props.value || { label: "Select...", value: "" },
      isOpen: false
    };
    this.mounted = true;
  }

  _inherits(Dropdown, _React$Component);

  _createClass(Dropdown, {
    componentWillReceiveProps: {
      value: function componentWillReceiveProps(newProps) {
        if (newProps.value && newProps.value !== this.state.selected) {
          this.setState({ selected: newProps.value });
        }
      }
    },
    componentWillMount: {
      value: function componentWillMount() {
        document.addEventListener("click", this.handleDocumentClick.bind(this), false);
      }
    },
    componentWillUnmount: {
      value: function componentWillUnmount() {
        this.mounted = false;
        document.removeEventListener("click", this.handleDocumentClick.bind(this), false);
      }
    },
    handleMouseDown: {
      value: function handleMouseDown(event) {

        if (event.type == "mousedown" && event.button !== 0) {
          return;
        }event.stopPropagation();
        event.preventDefault();

        this.setState({
          isOpen: !this.state.isOpen
        });
      }
    },
    setValue: {
      value: function setValue(option) {
        var newState = {
          selected: option,
          isOpen: false
        };
        this.fireChangeEvent(newState);
        this.setState(newState);
      }
    },
    fireChangeEvent: {
      value: function fireChangeEvent(newState) {
        if (newState.selected !== this.state.selected && this.props.onChange) {
          this.props.onChange(newState.selected);
        }
      }
    },
    renderOption: {
      value: function renderOption(option) {
        var optionClass = classNames({
          "Dropdown-option": true,
          "is-selected": option == this.state.selected
        });

        return React.createElement(
          "div",
          { key: option.value, className: optionClass, onMouseDown: this.setValue.bind(this, option), onClick: this.setValue.bind(this, option) },
          option.label
        );
      }
    },
    buildMenu: {
      value: function buildMenu() {
        var _this = this;

        var ops = this.props.options.map(function (option) {
          if (option.type == "group") {
            var groupTitle = React.createElement(
              "div",
              { className: "title" },
              option.name
            );
            var _options = option.items.map(function (item) {
              return _this.renderOption(item);
            });

            return React.createElement(
              "div",
              { className: "group", key: option.name },
              groupTitle,
              _options
            );
          } else {
            return _this.renderOption(option);
          }
        });

        return ops.length ? ops : React.createElement(
          "div",
          { className: "Dropdown-noresults" },
          "No opitons found"
        );
      }
    },
    handleDocumentClick: {
      value: function handleDocumentClick(event) {
        if (this.mounted) {
          if (!React.findDOMNode(this).contains(event.target)) {
            this.setState({ isOpen: false });
          }
        }
      }
    },
    render: {
      value: function render() {
        var value = React.createElement(
          "div",
          { className: "placeholder" },
          this.state.selected.label
        );
        var menu = this.state.isOpen ? React.createElement(
          "div",
          { className: "Dropdown-menu" },
          this.buildMenu()
        ) : null;

        var dropdownClass = classNames({
          Dropdown: true,
          "is-open": this.state.isOpen
        });

        return React.createElement(
          "div",
          { className: dropdownClass },
          React.createElement(
            "div",
            { className: "Dropdown-control", onMouseDown: this.handleMouseDown.bind(this), onTouchEnd: this.handleMouseDown.bind(this) },
            value,
            React.createElement("span", { className: "Dropdown-arrow" })
          ),
          menu
        );
      }
    }
  });

  return Dropdown;
})(React.Component);


var TempestRating = React.createClass({
  getInitialState: function() {
    return {rating: 0, items: []};
  },
  render: function() {
  }

});

var TempestItem = React.createClass({
  render: function() {

    var dif = this.props.expire - Date.now();
    var remain = new Date(dif);
    var mins = remain.getMinutes();
    var str;

    console.log("rendering");

    if (mins){
      str = mins + " minutes remaining ";
    }else{
      str = " < 1 minute remaining"
    }


    return (

      <div className="tempestItem item">
        <div className="ui tiny image">
          <img src="map.png"/>
        </div>
        <div className="content">
          <a className="header">
            {this.props.zone}
          </a>
          <div className="meta">
            <span>{str}</span>
          </div>
          <div className="description">
          <p>
              Description Of Tempest
          </p>

          </div>
          <div className="bottom aligned extra">
          <div className="ui label">{this.props.difficulty}</div>
          <div className="ui label">{this.props.type}</div>

            <div className="ui right floated">
              <img src="blue.png"/>
              <img src="blue.png"/>
              <img src="blue.png"/>
              <img src="blue.png" className="grayscale"/>
              <img src="blue.png" className="grayscale"/>
            </div>
          </div>

        </div>
      </div>
    );
  }
});

var TempestList = React.createClass({
  render: function() {

    var tempestNodes = this.props.data.map(function (tempest) {
     return (
       <TempestItem type={tempest.type} difficulty={tempest.difficulty} zone={tempest.zone} expire={tempest.expire}>

       </TempestItem>
     );
   });

    return (
      <div className="tempestList ui divided items">
        {tempestNodes}
      </div>
    );
  }
});


var CommentBox = React.createClass({
  getInitialState: function() {
    return {data: [],selectedDifficulty: { value: 'merciless', label: 'merciless'}};
  },
  loadCommentsFromServer: function() {

    var self = this;
    var es = new EventSource("http://gdf3.com:555/es");
    es.onerror=function(e){
      es.close();
    }

    es.addEventListener("TEMPEST",function(e){
      var t = JSON.parse(e.data);

      var toAdd=[].concat(t).map(function(x){
        var clone = JSON.parse(JSON.stringify(x));
        clone.expire = new Date(clone.expire);
        return clone;
      });



      var combined = self.state.data.concat(toAdd);
      console.log("toadd",combined);


      self.setState({data:combined});
    });

  },
  selectDifficulty:function(option){

    this.setState({selectedDifficulty:option});

  },
  refreshTempests:function(){
    var self=this;
    var now = Date.now();
    var temp = this.state.data.filter(function(t){
      console.log("queue");
      return (t.expire > now);
    });

    this.setState({data:temp});

  },
  render: function() {
    var self=this;

    var filtered = this.state.data.filter(function(t){
      return (t.difficulty.toLowerCase()===self.state.selectedDifficulty.value);
    });

    return (
      <div className="commentBox">
        <h1>Active Tempests</h1>
        <div className="ui grid">
          <div className="eight wide column">
            <Dropdown options={this.props.options} value={this.state.selectedDifficulty} onChange={this.selectDifficulty}/>
          </div>
          <div className="eight wide column">
            <Dropdown options={this.props.options2} />
          </div>
        </div>
        <TempestList data={filtered} />

      </div>
    );
  },
  componentDidMount: function() {
    this.loadCommentsFromServer();
    setInterval(this.refreshTempests, 5000);
  },
  pushComment:function(){

  }
});


var options = [
  { value: 'merciless', label: 'merciless' },
  { value: 'cruel', label: 'cruel' },
  { value: 'normal', label: 'normal' }
];


var options2 = [
  { value: '1', label: '1' },
  { value: '2', label: '2' },
  { value: '3', label: '3' }
];

React.render(

  <CommentBox options={options} options2={options2}/>,
  document.getElementById('content')
);
</script>


<script>
"use strict";

/*
(function(){

  //var el = document.getElementById("esDisplay");
  var el = document.querySelector("table#Tempest>tbody");

  var temp = [];
  var es = new EventSource("http://gdf3.com:555/es");
  es.onerror=function(e){
    es.close();
  }

  es.addEventListener("TEMPEST",function(e){
    var t = JSON.parse(e.data);

    var toAdd=[].concat(t).map(function(x){
      var clone = JSON.parse(JSON.stringify(x));
      clone.expire = new Date(clone.expire);
      return clone;
    });


    temp = temp.concat(toAdd);
    console.log(temp);
  });

  var refreshList = function(){
    var now = Date.now();

    temp = temp.filter(function(t){
      return t.expire > now;
    });

    var d = document.createDocumentFragment();
    var elements = temp.map(function(t){
      var tr = document.createElement("tr");
      var left = new Date(t.expire - now);

      var mins = left.getMinutes();

      var td = document.createElement("td");
      td.innerHTML=t.type;
      tr.appendChild(td);

      td = document.createElement("td");
      td.innerHTML=t.difficulty;
      tr.appendChild(td);

      td = document.createElement("td");
      td.innerHTML=t.zone;
      tr.appendChild(td);

//      var inner = t.type + " " + t.zone + " " + t.difficulty + ", ";

      td = document.createElement("td");

      if (mins){
        td.innerHTML = mins + " minutes remaining ";
      }else{
        td.innerHTML = " < 1 minute remaining"
      }

      tr.appendChild(td);


  //    n.innerHTML= inner;
    //  return n;
    return tr;
    });

    elements.forEach(function(row){
      d.appendChild(row);
    });

    el.innerHTML="";
    el.appendChild(d);
  };

  setInterval(refreshList,1000);

})();


var HttpClient = function(){
"use strict";
	var Post = function(tempest){
		var promise = new Promise( function (resolve, reject) {

			var client = new XMLHttpRequest();

			client.onload=function(e){
				if (this.status==200){
					resolve(this.status);
				}else{
					reject(this.statusText);
				}

			};

			var json = JSON.stringify(tempest);
			client.open("POST","http://gdf3.com:555/tempest");
			client.send(json);

		});//<-- forgot this )

	};

	return {Post:Post};

};

var testtempest = {"type":"tempest","difficulty":"merciless","zone":"mountain ledge","startTime":"now","endTime":"later"};
var client = HttpClient();

*/
</script>
</body>
</html>
