<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>TempestTracker</title>
    <script src="src/model/Tempest.js"></script>

    <style>
        body {
            background: url(http://webcdn.pathofexile.com/image/layout/background-awakening-release.jpg?1435660190);
        }
        h1 {
            color: firebrick;
            margin-left: 40px;
        }
    </style>
</head>
<body>
<h1>TempestTracker</h1>

<table class ="sortable" id="Tempest" cellspacing="50" cellpadding="10" style="background-color:ghostwhite">
    <thead><tr><th>Type</th><th>Difficulty</th><th>Zone</th><th>Remaining Time</th></tr></thead>
    <tbody></tbody>
</table>

<menu>
    <li><a href="listTempests.html"><button type="button">List all active tempests</button></a></li>
    <li><a href="createTempest.html"><button type="button">Add a new tempest</button></a></li>
    <li><button type="button" onclick="Tempest.createTestData()">Create test data</button></li>
</menu>

<ul id="esDisplay"></ul>

<script>
"use strict";
(function(){

  //var el = document.getElementById("esDisplay");
  var el = document.querySelector("table#Tempest>tbody");

  var temp = [];
  var es = new EventSource("http://gdf3.com:555/es");
  es.onerror=function(e){
    es.close();
  }

  es.addEventListener("TEMPEST",function(e){
    var t = JSON.parse(e.data);

    var toAdd=[].concat(t).map(function(x){
      var clone = JSON.parse(JSON.stringify(x));
      clone.expire = new Date(clone.expire);
      return clone;
    });


    temp = temp.concat(toAdd);
    console.log(temp);
  });

  var refreshList = function(){
    var now = Date.now();

    temp = temp.filter(function(t){
      return t.expire > now;
    });

    var d = document.createDocumentFragment();
    var elements = temp.map(function(t){
      var tr = document.createElement("tr");
      var left = new Date(t.expire - now);

      var mins = left.getMinutes();

      var td = document.createElement("td");
      td.innerHTML=t.type;
      tr.appendChild(td);

      td = document.createElement("td");
      td.innerHTML=t.difficulty;
      tr.appendChild(td);

      td = document.createElement("td");
      td.innerHTML=t.zone;
      tr.appendChild(td);

//      var inner = t.type + " " + t.zone + " " + t.difficulty + ", ";

      td = document.createElement("td");

      if (mins){
        td.innerHTML = mins + " minutes remaining ";
      }else{
        td.innerHTML = " < 1 minute remaining"
      }

      tr.appendChild(td);


  //    n.innerHTML= inner;
    //  return n;
    return tr;
    });

    elements.forEach(function(row){
      d.appendChild(row);
    });

    el.innerHTML="";
    el.appendChild(d);
  };

  setInterval(refreshList,1000);

})();


var HttpClient = function(){
"use strict";
	var Post = function(tempest){
		var promise = new Promise( function (resolve, reject) {

			var client = new XMLHttpRequest();

			client.onload=function(e){
				if (this.status==200){
					resolve(this.status);
				}else{
					reject(this.statusText);
				}

			};

			var json = JSON.stringify(tempest);
			client.open("POST","http://gdf3.com:555/tempest");
			client.send(json);

		});//<-- forgot this )

	};

	return {Post:Post};

};

var testtempest = {"type":"tempest","difficulty":"merciless","zone":"mountain ledge","startTime":"now","endTime":"later"};
var client = HttpClient();


</script>
</body>
</html>
